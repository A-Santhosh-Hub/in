<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Money Flow - Smart Tracker</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Icons (Lucide) -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="icon" type="image/png" href="logo.png" />
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Outfit', 'sans-serif'],
                    },
                    colors: {
                        glass: {
                            100: 'rgba(255, 255, 255, 0.1)',
                            200: 'rgba(255, 255, 255, 0.2)',
                            300: 'rgba(255, 255, 255, 0.3)',
                            dark: 'rgba(15, 23, 42, 0.6)'
                        },
                        brand: {
                            500: '#6366f1', // Indigo
                            600: '#4f46e5',
                        }
                    }
                }
            }
        }
    </script>

    <style>
        /* Custom Styles & Glassmorphism */
        body {
            font-family: 'Outfit', sans-serif;
            background: linear-gradient(135deg, #f0f4ff 0%, #e0e7ff 100%);
            min-height: 100vh;
            transition: background 0.5s ease;
        }

        body.dark {
            background: linear-gradient(135deg, #0f172a 0%, #1e1b4b 100%);
            color: #e2e8f0;
        }

        /* Glass Cards */
        .glass-panel {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.5);
        }

        .dark .glass-panel {
            background: rgba(30, 41, 59, 0.7);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        /* Neumorphic/Soft Shadow */
        .soft-shadow {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 
                        0 2px 4px -1px rgba(0, 0, 0, 0.03);
        }

        .dark .soft-shadow {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3);
        }

        /* Animations */
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .animate-entry {
            animation: slideIn 0.3s ease-out forwards;
        }

        /* Hide Scrollbar but keep functionality */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        /* Branding Hover */
        .brand-link {
            position: relative;
            text-decoration: none;
        }
        .brand-link::after {
            content: '';
            position: absolute;
            width: 100%;
            transform: scaleX(0);
            height: 2px;
            bottom: -2px;
            left: 0;
            background-color: currentColor;
            transform-origin: bottom right;
            transition: transform 0.25s ease-out;
        }
        .brand-link:hover::after {
            transform: scaleX(1);
            transform-origin: bottom left;
        }

        /* Mobile Fab */
        .fab {
            position: fixed;
            bottom: 80px;
            right: 20px;
            z-index: 40;
            transition: transform 0.2s;
        }
        .fab:active {
            transform: scale(0.95);
        }
    </style>
</head>
<body class="text-slate-800 antialiased selection:bg-brand-500 selection:text-white pb-20 md:pb-10">

    <!-- App Container -->
    <div id="app" class="max-w-5xl mx-auto p-4 md:p-6 min-h-screen flex flex-col">

        <!-- Header -->
        <header class="flex justify-between items-center mb-6 animate-entry">
            <div class="flex items-center gap-3">
                <div class="bg-brand-500 text-white p-2 rounded-xl shadow-lg shadow-brand-500/30">
                    <i data-lucide="wallet" class="w-6 h-6"></i>
                </div>
                <div>
                    <h1 class="text-2xl font-bold tracking-tight">Money Flow</h1>
                    <p class="text-xs text-slate-500 dark:text-slate-400 font-medium">Smart UPI Tracker</p>
                </div>
            </div>
            <button onclick="toggleTheme()" class="p-2 rounded-full hover:bg-black/5 dark:hover:bg-white/10 transition-colors">
                <i data-lucide="moon" class="w-5 h-5 dark:hidden"></i>
                <i data-lucide="sun" class="w-5 h-5 hidden dark:block text-yellow-400"></i>
            </button>
        </header>

        <!-- Navigation Tabs (Desktop: Top, Mobile: Bottom fixed) -->
        <nav class="hidden md:flex gap-2 mb-6 animate-entry" style="animation-delay: 0.1s;">
            <button onclick="switchTab('dashboard')" class="nav-btn active px-4 py-2 rounded-lg font-medium transition-all text-sm flex items-center gap-2 bg-brand-500 text-white shadow-lg shadow-brand-500/25">
                <i data-lucide="layout-dashboard" class="w-4 h-4"></i> Dashboard
            </button>
            <button onclick="switchTab('transactions')" class="nav-btn px-4 py-2 rounded-lg font-medium text-slate-600 dark:text-slate-400 hover:bg-white/50 dark:hover:bg-white/5 transition-all text-sm flex items-center gap-2">
                <i data-lucide="arrow-left-right" class="w-4 h-4"></i> Transactions
            </button>
            <button onclick="switchTab('pending')" class="nav-btn px-4 py-2 rounded-lg font-medium text-slate-600 dark:text-slate-400 hover:bg-white/50 dark:hover:bg-white/5 transition-all text-sm flex items-center gap-2">
                <i data-lucide="clock" class="w-4 h-4"></i> Pending / Debts
            </button>
            <button onclick="switchTab('people')" class="nav-btn px-4 py-2 rounded-lg font-medium text-slate-600 dark:text-slate-400 hover:bg-white/50 dark:hover:bg-white/5 transition-all text-sm flex items-center gap-2">
                <i data-lucide="users" class="w-4 h-4"></i> People
            </button>
            <button onclick="switchTab('settings')" class="nav-btn px-4 py-2 rounded-lg font-medium text-slate-600 dark:text-slate-400 hover:bg-white/50 dark:hover:bg-white/5 transition-all text-sm flex items-center gap-2">
                <i data-lucide="settings" class="w-4 h-4"></i> Settings
            </button>
        </nav>

        <!-- Dynamic Content Area -->
        <main class="flex-1 relative">
            
            <!-- VIEW: DASHBOARD -->
            <section id="view-dashboard" class="space-y-6 animate-entry" style="animation-delay: 0.2s;">
                <!-- Summary Cards -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="glass-panel p-5 rounded-2xl soft-shadow relative overflow-hidden group">
                        <div class="absolute right-0 top-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity">
                            <i data-lucide="arrow-up-right" class="w-16 h-16 text-red-500"></i>
                        </div>
                        <p class="text-sm text-slate-500 dark:text-slate-400 font-medium">Sent (This Month)</p>
                        <h3 class="text-2xl font-bold text-red-500 mt-1" id="dash-sent">₹0</h3>
                        <p class="text-xs text-slate-400 mt-2 flex items-center gap-1">
                            <i data-lucide="trending-up" class="w-3 h-3"></i> <span id="dash-sent-count">0</span> txns
                        </p>
                    </div>

                    <div class="glass-panel p-5 rounded-2xl soft-shadow relative overflow-hidden group">
                        <div class="absolute right-0 top-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity">
                            <i data-lucide="arrow-down-left" class="w-16 h-16 text-green-500"></i>
                        </div>
                        <p class="text-sm text-slate-500 dark:text-slate-400 font-medium">Received (This Month)</p>
                        <h3 class="text-2xl font-bold text-green-500 mt-1" id="dash-received">₹0</h3>
                        <p class="text-xs text-slate-400 mt-2 flex items-center gap-1">
                            <i data-lucide="trending-down" class="w-3 h-3"></i> <span id="dash-received-count">0</span> txns
                        </p>
                    </div>

                    <div class="glass-panel p-5 rounded-2xl soft-shadow relative overflow-hidden group bg-gradient-to-br from-brand-500/10 to-transparent">
                        <div class="absolute right-0 top-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity">
                            <i data-lucide="wallet" class="w-16 h-16 text-brand-500"></i>
                        </div>
                        <p class="text-sm text-slate-500 dark:text-slate-400 font-medium">Net Balance Flow</p>
                        <h3 class="text-2xl font-bold text-slate-800 dark:text-white mt-1" id="dash-balance">₹0</h3>
                        <p class="text-xs text-slate-400 mt-2" id="dash-balance-msg">Keep it up!</p>
                    </div>
                </div>

                <!-- Charts Section -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="glass-panel p-5 rounded-2xl soft-shadow">
                        <h3 class="font-semibold mb-4 text-sm uppercase tracking-wider text-slate-500">Top Categories</h3>
                        <div class="h-64 relative w-full">
                            <canvas id="chartCategories"></canvas>
                        </div>
                    </div>
                    <div class="glass-panel p-5 rounded-2xl soft-shadow">
                        <h3 class="font-semibold mb-4 text-sm uppercase tracking-wider text-slate-500">Monthly Trend</h3>
                        <div class="h-64 relative w-full">
                            <canvas id="chartTrend"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Alert Section -->
                <div id="pending-alert-container" class="hidden">
                    <div class="bg-orange-100 dark:bg-orange-900/30 border border-orange-200 dark:border-orange-800 p-4 rounded-xl flex items-center justify-between">
                        <div class="flex items-center gap-3">
                            <div class="bg-orange-500 text-white p-2 rounded-lg">
                                <i data-lucide="alert-circle" class="w-5 h-5"></i>
                            </div>
                            <div>
                                <h4 class="font-semibold text-orange-700 dark:text-orange-400">Pending Dues</h4>
                                <p class="text-xs text-orange-600/80 dark:text-orange-500/80">People owe you <span id="alert-amt" class="font-bold">₹0</span></p>
                            </div>
                        </div>
                        <button onclick="switchTab('pending')" class="text-xs font-bold text-orange-600 hover:underline">View All</button>
                    </div>
                </div>
            </section>

            <!-- VIEW: TRANSACTIONS -->
            <section id="view-transactions" class="hidden space-y-4 animate-entry">
                <div class="flex flex-col md:flex-row gap-3 justify-between items-start md:items-center">
                    <h2 class="text-xl font-bold">Transaction History</h2>
                    <div class="flex gap-2 w-full md:w-auto">
                        <input type="text" id="search-tx" placeholder="Search name, category..." class="flex-1 bg-white/50 dark:bg-slate-800/50 border border-slate-200 dark:border-slate-700 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-brand-500">
                        <select id="filter-category" class="bg-white/50 dark:bg-slate-800/50 border border-slate-200 dark:border-slate-700 rounded-lg px-3 py-2 text-sm focus:outline-none">
                            <option value="all">All Categories</option>
                            <!-- Populated by JS -->
                        </select>
                    </div>
                </div>

                <div class="glass-panel rounded-2xl soft-shadow overflow-hidden">
                    <div id="tx-list" class="divide-y divide-slate-200/50 dark:divide-slate-700/50 max-h-[60vh] overflow-y-auto no-scrollbar">
                        <!-- Transaction Items go here -->
                        <div class="p-8 text-center text-slate-400">
                            <p>No transactions found.</p>
                        </div>
                    </div>
                </div>
            </section>

            <!-- VIEW: PENDING / DEBTS -->
            <section id="view-pending" class="hidden space-y-6 animate-entry">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- They Owe Me -->
                    <div>
                        <h3 class="font-bold text-green-600 mb-3 flex items-center gap-2">
                            <i data-lucide="download" class="w-5 h-5"></i> To Receive (You are owed)
                        </h3>
                        <div class="glass-panel rounded-2xl soft-shadow overflow-hidden min-h-[200px]">
                            <div id="owe-me-list" class="divide-y divide-slate-200/50 dark:divide-slate-700/50"></div>
                        </div>
                    </div>

                    <!-- I Owe Them -->
                    <div>
                        <h3 class="font-bold text-red-500 mb-3 flex items-center gap-2">
                            <i data-lucide="upload" class="w-5 h-5"></i> To Pay (You owe)
                        </h3>
                        <div class="glass-panel rounded-2xl soft-shadow overflow-hidden min-h-[200px]">
                            <div id="i-owe-list" class="divide-y divide-slate-200/50 dark:divide-slate-700/50"></div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- VIEW: PEOPLE -->
            <section id="view-people" class="hidden space-y-4 animate-entry">
                <div class="flex justify-between items-center">
                    <h2 class="text-xl font-bold">People & Contacts</h2>
                    <button onclick="openModal('modal-person')" class="bg-slate-800 dark:bg-white text-white dark:text-slate-900 px-4 py-2 rounded-lg text-sm font-medium hover:opacity-90 transition-opacity">
                        + Add Person
                    </button>
                </div>
                <div id="people-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <!-- People Cards populated by JS -->
                </div>
            </section>

            <!-- VIEW: SETTINGS -->
            <section id="view-settings" class="hidden space-y-6 animate-entry">
                <h2 class="text-xl font-bold">Settings</h2>
                
                <div class="glass-panel p-6 rounded-2xl soft-shadow space-y-6">
                    <div>
                        <h3 class="font-semibold mb-2">Preferences</h3>
                        <div class="flex items-center justify-between p-3 bg-white/30 dark:bg-white/5 rounded-lg">
                            <span>Currency Symbol</span>
                            <select id="setting-currency" class="bg-transparent font-mono font-bold focus:outline-none border border-slate-300 dark:border-slate-600 rounded px-2">
                                <option value="₹">₹ (INR)</option>
                                <option value="$">$ (USD)</option>
                                <option value="€">€ (EUR)</option>
                                <option value="£">£ (GBP)</option>
                            </select>
                        </div>
                    </div>

                    <div class="border-t border-slate-200/50 dark:border-slate-700/50 pt-4">
                        <h3 class="font-semibold mb-2 text-slate-600 dark:text-slate-400 text-sm uppercase">Data Management</h3>
                        <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
                            <button onclick="exportData()" class="flex items-center justify-center gap-2 p-3 rounded-lg border border-slate-300 dark:border-slate-600 hover:bg-slate-100 dark:hover:bg-slate-800 transition">
                                <i data-lucide="download" class="w-4 h-4"></i> Backup Data
                            </button>
                            <label class="flex items-center justify-center gap-2 p-3 rounded-lg border border-slate-300 dark:border-slate-600 hover:bg-slate-100 dark:hover:bg-slate-800 transition cursor-pointer">
                                <i data-lucide="upload" class="w-4 h-4"></i> Restore Data
                                <input type="file" id="import-file" class="hidden" accept=".json" onchange="importData(this)">
                            </label>
                            <button onclick="resetData()" class="flex items-center justify-center gap-2 p-3 rounded-lg border border-red-200 text-red-600 hover:bg-red-50 dark:hover:bg-red-900/20 transition">
                                <i data-lucide="trash-2" class="w-4 h-4"></i> Reset All
                            </button>
                        </div>
                    </div>
                </div>
            </section>
        </main>

        <!-- FOOTER -->
        <footer class="mt-10 text-center text-xs text-slate-400 font-medium">
            <p>Developed By <a href="https://sanstudio.neocities.org/" target="_blank" class="text-brand-500 brand-link">SanStudio</a></p>
            <p class="opacity-50 mt-1">100% Offline • No Server</p>
        </footer>

        <!-- Mobile Bottom Nav -->
        <div class="md:hidden fixed bottom-0 left-0 w-full bg-white/90 dark:bg-slate-900/90 backdrop-blur-md border-t border-slate-200 dark:border-slate-800 p-2 flex justify-around items-center z-50">
            <button onclick="switchTab('dashboard')" class="p-2 rounded-lg flex flex-col items-center gap-1 text-slate-500 nav-icon active-mobile" data-target="dashboard">
                <i data-lucide="layout-dashboard" class="w-5 h-5"></i>
                <span class="text-[10px]">Home</span>
            </button>
            <button onclick="switchTab('transactions')" class="p-2 rounded-lg flex flex-col items-center gap-1 text-slate-500 nav-icon" data-target="transactions">
                <i data-lucide="arrow-left-right" class="w-5 h-5"></i>
                <span class="text-[10px]">Txns</span>
            </button>
            <div class="w-12"></div> <!-- Spacer for FAB -->
            <button onclick="switchTab('pending')" class="p-2 rounded-lg flex flex-col items-center gap-1 text-slate-500 nav-icon" data-target="pending">
                <i data-lucide="clock" class="w-5 h-5"></i>
                <span class="text-[10px]">Debts</span>
            </button>
            <button onclick="switchTab('people')" class="p-2 rounded-lg flex flex-col items-center gap-1 text-slate-500 nav-icon" data-target="people">
                <i data-lucide="users" class="w-5 h-5"></i>
                <span class="text-[10px]">People</span>
            </button>
        </div>

        <!-- Floating Action Button (FAB) -->
        <button onclick="openModal('modal-tx')" class="fab bg-brand-600 hover:bg-brand-500 text-white p-4 rounded-full shadow-lg shadow-brand-500/40 flex items-center justify-center group">
            <i data-lucide="plus" class="w-6 h-6 group-hover:rotate-90 transition-transform"></i>
        </button>

    </div>

    <!-- MODALS -->

    <!-- Modal: Add Transaction -->
    <div id="modal-tx" class="fixed inset-0 z-50 hidden">
        <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm" onclick="closeModal('modal-tx')"></div>
        <div class="absolute bottom-0 md:top-1/2 md:left-1/2 md:transform md:-translate-x-1/2 md:-translate-y-1/2 w-full md:w-[480px] bg-white dark:bg-slate-900 rounded-t-2xl md:rounded-2xl shadow-2xl animate-entry p-6 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-bold">New Transaction</h3>
                <button onclick="closeModal('modal-tx')" class="p-1 rounded-full hover:bg-slate-100 dark:hover:bg-slate-800"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            
            <form id="form-tx" onsubmit="handleTxSubmit(event)">
                <!-- Type Toggle -->
                <div class="grid grid-cols-2 gap-2 p-1 bg-slate-100 dark:bg-slate-800 rounded-lg mb-4">
                    <button type="button" class="tx-type-btn py-2 text-sm font-medium rounded-md bg-white dark:bg-slate-700 shadow-sm text-red-500" data-type="send" onclick="setTxType('send')">Send</button>
                    <button type="button" class="tx-type-btn py-2 text-sm font-medium rounded-md text-slate-500" data-type="receive" onclick="setTxType('receive')">Receive</button>
                </div>
                <input type="hidden" id="inp-tx-type" value="send">

                <!-- Person Selection -->
                <div class="mb-4">
                    <label class="block text-xs font-semibold uppercase text-slate-500 mb-1">Person / Entity</label>
                    <div class="flex gap-2">
                        <select id="inp-tx-person" class="flex-1 bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-brand-500 outline-none" onchange="checkPersonDetails()">
                            <option value="">Select Person...</option>
                            <!-- Populated JS -->
                        </select>
                        <button type="button" onclick="closeModal('modal-tx'); openModal('modal-person')" class="p-2 bg-slate-200 dark:bg-slate-700 rounded-lg"><i data-lucide="user-plus" class="w-4 h-4"></i></button>
                    </div>
                </div>

                <!-- UPI Helper (Conditional) -->
                <div id="upi-helper" class="hidden mb-4 p-3 bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-lg">
                    <div class="flex items-center justify-between">
                        <span class="text-xs font-bold text-blue-600 dark:text-blue-400">UPI ID Available</span>
                        <button type="button" id="btn-copy-upi" class="text-xs bg-blue-100 dark:bg-blue-800 text-blue-700 dark:text-blue-300 px-2 py-1 rounded" onclick="copyUPI()">Copy ID</button>
                    </div>
                    <p id="upi-display" class="text-sm font-mono mt-1 select-all text-slate-700 dark:text-slate-300">example@upi</p>
                </div>

                <!-- Amount & Category -->
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block text-xs font-semibold uppercase text-slate-500 mb-1">Amount</label>
                        <input type="number" id="inp-tx-amount" required min="1" step="0.01" class="w-full bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-lg px-3 py-2 text-lg font-bold focus:ring-2 focus:ring-brand-500 outline-none" placeholder="0.00">
                    </div>
                    <div>
                        <label class="block text-xs font-semibold uppercase text-slate-500 mb-1">Category</label>
                        <select id="inp-tx-category" class="w-full bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-brand-500 outline-none">
                            <!-- Populated JS -->
                        </select>
                    </div>
                </div>

                <!-- Split / Debt Toggle -->
                <div id="div-debt-toggle" class="mb-4">
                    <label class="flex items-center gap-2 p-3 border border-slate-200 dark:border-slate-700 rounded-lg cursor-pointer hover:bg-slate-50 dark:hover:bg-slate-800 transition">
                        <input type="checkbox" id="inp-tx-pending" class="w-4 h-4 accent-brand-500">
                        <div class="flex-1">
                            <span class="block text-sm font-medium" id="txt-debt-label">Mark as Pending (They owe me)</span>
                            <span class="block text-xs text-slate-500">Track this as a debt until paid back</span>
                        </div>
                    </label>
                </div>

                <div class="mb-6">
                    <label class="block text-xs font-semibold uppercase text-slate-500 mb-1">Note (Optional)</label>
                    <input type="text" id="inp-tx-note" class="w-full bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-brand-500 outline-none" placeholder="Dinner, Rent, etc.">
                </div>

                <button type="submit" class="w-full bg-brand-600 hover:bg-brand-700 text-white font-bold py-3 rounded-xl shadow-lg shadow-brand-500/25 transition-all active:scale-[0.98]">
                    Save Transaction
                </button>

                <!-- QR Helper Link -->
                <div id="qr-help-link" class="mt-4 text-center">
                   <button type="button" onclick="toggleQRView()" class="text-xs text-slate-500 underline flex items-center justify-center gap-1 mx-auto"><i data-lucide="qr-code" class="w-3 h-3"></i> Use QR Helper</button>
                </div>
            </form>
            
            <!-- QR Simulation View -->
            <div id="qr-view" class="hidden mt-4 text-center bg-slate-100 dark:bg-slate-800 p-4 rounded-xl">
                <i data-lucide="scan-line" class="w-12 h-12 mx-auto text-slate-400 mb-2"></i>
                <p class="text-sm font-medium mb-2">Scan QR in your UPI App</p>
                <p class="text-xs text-slate-500 mb-3">This tool doesn't process actual payments. Use your GPay/PhonePe to pay, then record it here.</p>
                <button type="button" onclick="toggleQRView()" class="text-xs bg-slate-200 dark:bg-slate-700 px-3 py-1 rounded">Back to Form</button>
            </div>
        </div>
    </div>

    <!-- Modal: Add Person -->
    <div id="modal-person" class="fixed inset-0 z-50 hidden">
        <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm" onclick="closeModal('modal-person')"></div>
        <div class="absolute bottom-0 md:top-1/2 md:left-1/2 md:transform md:-translate-x-1/2 md:-translate-y-1/2 w-full md:w-[400px] bg-white dark:bg-slate-900 rounded-t-2xl md:rounded-2xl shadow-2xl animate-entry p-6">
            <h3 class="text-lg font-bold mb-4">Add New Person</h3>
            <form onsubmit="handlePersonSubmit(event)" class="space-y-4">
                <div>
                    <label class="block text-xs font-semibold uppercase text-slate-500 mb-1">Name</label>
                    <input type="text" id="inp-person-name" required class="w-full bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-brand-500 outline-none">
                </div>
                <div>
                    <label class="block text-xs font-semibold uppercase text-slate-500 mb-1">UPI ID / Phone (Optional)</label>
                    <input type="text" id="inp-person-upi" class="w-full bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-brand-500 outline-none" placeholder="name@oksbi">
                </div>
                <div>
                    <label class="block text-xs font-semibold uppercase text-slate-500 mb-1">Default Category</label>
                    <select id="inp-person-cat" class="w-full bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-lg px-3 py-2 text-sm outline-none">
                        <option value="Friend">Friend</option>
                        <option value="Family">Family</option>
                        <option value="Work">Work</option>
                        <option value="Shop">Shop</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                <div class="flex gap-2 mt-4">
                    <button type="button" onclick="closeModal('modal-person')" class="flex-1 bg-slate-200 dark:bg-slate-700 text-slate-800 dark:text-white py-2 rounded-lg font-medium text-sm">Cancel</button>
                    <button type="submit" class="flex-1 bg-brand-600 text-white py-2 rounded-lg font-medium text-sm">Save</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Javascript Logic -->
    <script>
        // --- Data Layer ---
        const DB_KEY = 'moneyflow_db_v1';
        
        const DEFAULT_CATEGORIES = ['Food', 'Transport', 'Shopping', 'Bills', 'Rent', 'Entertainment', 'Health', 'Salary', 'Freelance', 'Other'];
        
        let db = {
            transactions: [],
            people: [],
            settings: { currency: '₹', theme: 'light' }
        };

        // Initialize
        function initApp() {
            const stored = localStorage.getItem(DB_KEY);
            if (stored) {
                db = JSON.parse(stored);
            } else {
                // Seed some data for first time users
                db.people.push({ id: 'p1', name: 'Self', upi: '', category: 'Self' });
                saveDB();
            }

            // Apply Theme
            if(db.settings.theme === 'dark') document.body.classList.add('dark');
            document.getElementById('setting-currency').value = db.settings.currency;

            // Render
            renderAll();
            lucide.createIcons();

            // Currency Listener
            document.getElementById('setting-currency').addEventListener('change', (e) => {
                db.settings.currency = e.target.value;
                saveDB();
                renderAll();
            });
        }

        function saveDB() {
            localStorage.setItem(DB_KEY, JSON.stringify(db));
            renderAll();
        }

        // --- Core Logic ---

        function addTransaction(tx) {
            db.transactions.unshift(tx); // Add to top
            saveDB();
        }

        function addPerson(person) {
            db.people.push(person);
            saveDB();
        }

        function settleDebt(txId) {
            const tx = db.transactions.find(t => t.id === txId);
            if (tx) {
                // Create a counter transaction to balance it out in history
                const counterTx = {
                    id: Date.now().toString(),
                    type: tx.type === 'send' ? 'receive' : 'send', // Reverse flow
                    amount: tx.amount,
                    personId: tx.personId,
                    category: 'Debt Repayment',
                    note: `Settlement for: ${tx.note || 'Debt'}`,
                    date: new Date().toISOString(),
                    isPending: false,
                    relatedId: txId
                };
                
                tx.isPending = false; // Mark original as resolved
                db.transactions.unshift(counterTx);
                saveDB();
                alert('Debt settled! Transaction recorded.');
            }
        }

        function deleteTransaction(id) {
            if(confirm('Delete this transaction?')) {
                db.transactions = db.transactions.filter(t => t.id !== id);
                saveDB();
            }
        }

        // --- UI Rendering ---

        function renderAll() {
            const currency = db.settings.currency;
            
            // 1. Dashboard Stats
            const now = new Date();
            const currentMonth = now.getMonth();
            const currentYear = now.getFullYear();

            const thisMonthTx = db.transactions.filter(t => {
                const d = new Date(t.date);
                return d.getMonth() === currentMonth && d.getFullYear() === currentYear && !t.isPending;
            });

            const sent = thisMonthTx.filter(t => t.type === 'send').reduce((sum, t) => sum + parseFloat(t.amount), 0);
            const received = thisMonthTx.filter(t => t.type === 'receive').reduce((sum, t) => sum + parseFloat(t.amount), 0);
            
            document.getElementById('dash-sent').innerText = `${currency}${sent.toFixed(2)}`;
            document.getElementById('dash-received').innerText = `${currency}${received.toFixed(2)}`;
            document.getElementById('dash-balance').innerText = `${currency}${(received - sent).toFixed(2)}`;
            
            document.getElementById('dash-sent-count').innerText = thisMonthTx.filter(t => t.type === 'send').length;
            document.getElementById('dash-received-count').innerText = thisMonthTx.filter(t => t.type === 'receive').length;

            const bal = received - sent;
            const balMsg = bal > 0 ? "You're saving money!" : (bal < 0 ? "Spending more than income." : "Perfectly balanced.");
            document.getElementById('dash-balance-msg').innerText = balMsg;

            // 2. Pending Alert
            const pendingIncoming = db.transactions.filter(t => t.isPending && t.type === 'send').reduce((sum, t) => sum + parseFloat(t.amount), 0);
            const alertBox = document.getElementById('pending-alert-container');
            if (pendingIncoming > 0) {
                alertBox.classList.remove('hidden');
                document.getElementById('alert-amt').innerText = `${currency}${pendingIncoming}`;
            } else {
                alertBox.classList.add('hidden');
            }

            // 3. Transactions List
            renderTransactionList();

            // 4. Pending/Debt List
            renderDebtLists();

            // 5. People
            renderPeopleGrid();

            // 6. Charts
            updateCharts(thisMonthTx);
            
            // 7. Form Population
            populateDropdowns();
        }

        function renderTransactionList() {
            const listEl = document.getElementById('tx-list');
            const filterCat = document.getElementById('filter-category').value;
            const searchText = document.getElementById('search-tx').value.toLowerCase();
            const currency = db.settings.currency;

            let filtered = db.transactions.filter(t => {
                const p = db.people.find(person => person.id === t.personId);
                const name = p ? p.name.toLowerCase() : 'unknown';
                const cat = t.category.toLowerCase();
                const note = (t.note || '').toLowerCase();
                
                const matchesSearch = name.includes(searchText) || cat.includes(searchText) || note.includes(searchText);
                const matchesCat = filterCat === 'all' || t.category === filterCat;
                
                return matchesSearch && matchesCat;
            });

            if (filtered.length === 0) {
                listEl.innerHTML = `<div class="p-8 text-center text-slate-400"><p>No transactions found.</p></div>`;
                return;
            }

            listEl.innerHTML = filtered.map(t => {
                const person = db.people.find(p => p.id === t.personId) || { name: 'Unknown' };
                const date = new Date(t.date).toLocaleDateString(undefined, { month: 'short', day: 'numeric' });
                const isSend = t.type === 'send';
                const colorClass = isSend ? 'text-red-500' : 'text-green-500';
                const icon = isSend ? 'arrow-up-right' : 'arrow-down-left';
                const sign = isSend ? '-' : '+';
                const pendingBadge = t.isPending 
                    ? `<span class="bg-orange-100 text-orange-600 text-[10px] px-2 py-0.5 rounded-full font-bold ml-2">PENDING</span>` 
                    : '';

                return `
                <div class="p-4 flex justify-between items-center hover:bg-white/30 dark:hover:bg-white/5 transition">
                    <div class="flex items-center gap-3">
                        <div class="p-2 rounded-full ${isSend ? 'bg-red-100 dark:bg-red-900/30' : 'bg-green-100 dark:bg-green-900/30'} ${colorClass}">
                            <i data-lucide="${icon}" class="w-4 h-4"></i>
                        </div>
                        <div>
                            <h4 class="font-semibold text-sm flex items-center">${person.name} ${pendingBadge}</h4>
                            <p class="text-xs text-slate-500">${t.category} • ${date}</p>
                            ${t.note ? `<p class="text-[10px] text-slate-400 italic">${t.note}</p>` : ''}
                        </div>
                    </div>
                    <div class="text-right">
                        <span class="font-bold ${colorClass}">${sign}${currency}${parseFloat(t.amount).toFixed(2)}</span>
                        ${!t.isPending ? `<button onclick="deleteTransaction('${t.id}')" class="block text-[10px] text-slate-300 hover:text-red-500 ml-auto mt-1">Delete</button>` : ''}
                    </div>
                </div>
                `;
            }).join('');
            
            lucide.createIcons();
        }

        function renderDebtLists() {
            const currency = db.settings.currency;
            // Owe Me: Type Send, Status Pending
            const oweMe = db.transactions.filter(t => t.type === 'send' && t.isPending);
            // I Owe: Type Receive, Status Pending
            const iOwe = db.transactions.filter(t => t.type === 'receive' && t.isPending);

            const renderDebtItem = (t, isOweMe) => {
                const person = db.people.find(p => p.id === t.personId) || { name: 'Unknown' };
                const date = new Date(t.date).toLocaleDateString();
                return `
                <div class="p-4 flex justify-between items-center">
                    <div>
                        <h4 class="font-bold text-sm">${person.name}</h4>
                        <p class="text-xs text-slate-500">${date} • ${t.note || 'No note'}</p>
                    </div>
                    <div class="text-right">
                        <div class="font-bold mb-1">${currency}${t.amount}</div>
                        <button onclick="settleDebt('${t.id}')" class="text-xs bg-brand-500 text-white px-2 py-1 rounded shadow hover:bg-brand-600 transition">
                            ${isOweMe ? 'Mark Received' : 'Mark Paid'}
                        </button>
                    </div>
                </div>
                `;
            };

            document.getElementById('owe-me-list').innerHTML = oweMe.length ? oweMe.map(t => renderDebtItem(t, true)).join('') : '<div class="p-4 text-xs text-slate-400">No one owes you money.</div>';
            document.getElementById('i-owe-list').innerHTML = iOwe.length ? iOwe.map(t => renderDebtItem(t, false)).join('') : '<div class="p-4 text-xs text-slate-400">You are debt free!</div>';
        }

        function renderPeopleGrid() {
            const grid = document.getElementById('people-grid');
            if(db.people.length === 0) {
                grid.innerHTML = '<p class="text-slate-400 text-sm">No people added yet.</p>';
                return;
            }
            grid.innerHTML = db.people.filter(p => p.id !== 'p1').map(p => `
                <div class="glass-panel p-4 rounded-xl soft-shadow flex justify-between items-center group">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-full bg-gradient-to-tr from-brand-500 to-purple-500 flex items-center justify-center text-white font-bold">
                            ${p.name.charAt(0).toUpperCase()}
                        </div>
                        <div>
                            <h4 class="font-bold text-sm">${p.name}</h4>
                            <p class="text-xs text-slate-500">${p.category} ${p.upi ? '• ' + p.upi : ''}</p>
                        </div>
                    </div>
                </div>
            `).join('');
            // Add self implicitly? No need to show self in grid usually
        }

        // --- Charts ---
        let chartCatInstance = null;
        let chartTrendInstance = null;

        function updateCharts(transactions) {
            // Category Chart (Expenses only)
            const expenses = transactions.filter(t => t.type === 'send');
            const catTotals = {};
            expenses.forEach(t => {
                catTotals[t.category] = (catTotals[t.category] || 0) + parseFloat(t.amount);
            });

            const ctxCat = document.getElementById('chartCategories').getContext('2d');
            if (chartCatInstance) chartCatInstance.destroy();

            chartCatInstance = new Chart(ctxCat, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(catTotals),
                    datasets: [{
                        data: Object.values(catTotals),
                        backgroundColor: ['#ef4444', '#f97316', '#eab308', '#22c55e', '#06b6d4', '#3b82f6', '#8b5cf6', '#d946ef'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'right', labels: { boxWidth: 10, font: {size: 10} } } }
                }
            });

            // Trend Chart (Last 6 months placeholder logic or just daily for this month)
            // Let's do Daily for current month
            const daysInMonth = new Date(new Date().getFullYear(), new Date().getMonth() + 1, 0).getDate();
            const labels = Array.from({length: daysInMonth}, (_, i) => i + 1);
            const dataSent = new Array(daysInMonth).fill(0);
            const dataRec = new Array(daysInMonth).fill(0);

            transactions.forEach(t => {
                const day = new Date(t.date).getDate() - 1;
                if(t.type === 'send') dataSent[day] += parseFloat(t.amount);
                else dataRec[day] += parseFloat(t.amount);
            });

            const ctxTrend = document.getElementById('chartTrend').getContext('2d');
            if (chartTrendInstance) chartTrendInstance.destroy();
            
            const isDark = document.body.classList.contains('dark');
            const gridColor = isDark ? 'rgba(255,255,255,0.1)' : 'rgba(0,0,0,0.05)';

            chartTrendInstance = new Chart(ctxTrend, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        { label: 'Sent', data: dataSent, backgroundColor: '#ef4444', borderRadius: 4 },
                        { label: 'Received', data: dataRec, backgroundColor: '#22c55e', borderRadius: 4 }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: { grid: { display: false } },
                        y: { grid: { color: gridColor }, beginAtZero: true }
                    },
                    plugins: { legend: { display: false } }
                }
            });
        }

        // --- Event Handlers & Forms ---

        // Dropdowns
        function populateDropdowns() {
            const catSelect = document.getElementById('inp-tx-category');
            const filterSelect = document.getElementById('filter-category');
            const personSelect = document.getElementById('inp-tx-person');
            
            // Save current selection to restore after re-render
            const currCat = catSelect.value;
            const currPerson = personSelect.value;
            const currFilter = filterSelect.value;

            // Categories
            const catOpts = DEFAULT_CATEGORIES.map(c => `<option value="${c}">${c}</option>`).join('');
            catSelect.innerHTML = catOpts;
            filterSelect.innerHTML = `<option value="all">All Categories</option>` + catOpts;

            // People
            const pplOpts = `<option value="">Select Person...</option>` + db.people.map(p => `<option value="${p.id}">${p.name}</option>`).join('');
            personSelect.innerHTML = pplOpts;

            // Restore
            if(currCat) catSelect.value = currCat;
            if(currPerson) personSelect.value = currPerson;
            if(currFilter) filterSelect.value = currFilter;
        }

        // Filtering
        document.getElementById('search-tx').addEventListener('input', renderTransactionList);
        document.getElementById('filter-category').addEventListener('change', renderTransactionList);

        // Transaction Modal Logic
        function setTxType(type) {
            document.getElementById('inp-tx-type').value = type;
            const btns = document.querySelectorAll('.tx-type-btn');
            btns.forEach(b => {
                if(b.dataset.type === type) {
                    b.classList.add('bg-white', 'dark:bg-slate-700', 'shadow-sm');
                    b.classList.remove('text-slate-500');
                    b.classList.add(type === 'send' ? 'text-red-500' : 'text-green-500');
                } else {
                    b.classList.remove('bg-white', 'dark:bg-slate-700', 'shadow-sm', 'text-red-500', 'text-green-500');
                    b.classList.add('text-slate-500');
                }
            });

            // Update Debt Toggle Text
            const debtLabel = document.getElementById('txt-debt-label');
            if (type === 'send') debtLabel.innerText = "Mark as Pending (They owe me)";
            else debtLabel.innerText = "Mark as Pending (I owe them)";
            
            // Check UPI helper visibility
            checkPersonDetails();
        }

        function checkPersonDetails() {
            const personId = document.getElementById('inp-tx-person').value;
            const type = document.getElementById('inp-tx-type').value;
            const helper = document.getElementById('upi-helper');
            
            if (type === 'send' && personId) {
                const p = db.people.find(x => x.id === personId);
                if (p && p.upi) {
                    helper.classList.remove('hidden');
                    document.getElementById('upi-display').innerText = p.upi;
                    return;
                }
            }
            helper.classList.add('hidden');
        }

        function copyUPI() {
            const text = document.getElementById('upi-display').innerText;
            navigator.clipboard.writeText(text).then(() => alert('UPI ID copied!'));
        }

        function toggleQRView() {
            const form = document.getElementById('form-tx').querySelector('div:first-child').parentElement; 
            const qr = document.getElementById('qr-view');
            // Simple toggle logic dependent on DOM structure slightly risky, using ID is better
            // Let's just toggle classes on specific IDs
            if(qr.classList.contains('hidden')) {
                qr.classList.remove('hidden');
                document.getElementById('qr-help-link').classList.add('hidden');
            } else {
                qr.classList.add('hidden');
                document.getElementById('qr-help-link').classList.remove('hidden');
            }
        }

        function handleTxSubmit(e) {
            e.preventDefault();
            const type = document.getElementById('inp-tx-type').value;
            const personId = document.getElementById('inp-tx-person').value;
            const amount = document.getElementById('inp-tx-amount').value;
            const category = document.getElementById('inp-tx-category').value;
            const note = document.getElementById('inp-tx-note').value;
            const isPending = document.getElementById('inp-tx-pending').checked;

            if (!personId || !amount) {
                alert('Please select a person and amount');
                return;
            }

            const tx = {
                id: Date.now().toString(),
                type,
                personId,
                amount,
                category,
                note,
                date: new Date().toISOString(),
                isPending
            };

            addTransaction(tx);
            closeModal('modal-tx');
            e.target.reset();
            setTxType('send'); // Reset UI
            renderAll();
            
            // Smart alert check
            if (type === 'send' && !isPending) {
                // Could ask "Did they pay you back?" here via timeout, but user workflow usually implies direct entry.
                // The Alert box in Dashboard handles the "Pending" checks.
            }
        }

        function handlePersonSubmit(e) {
            e.preventDefault();
            const name = document.getElementById('inp-person-name').value;
            const upi = document.getElementById('inp-person-upi').value;
            const cat = document.getElementById('inp-person-cat').value;

            addPerson({
                id: 'p' + Date.now(),
                name,
                upi,
                category: cat
            });

            closeModal('modal-person');
            e.target.reset();
            renderAll(); // Refresh dropdowns
        }

        // --- View Navigation ---
        function switchTab(tabId) {
            // Hide all sections
            document.querySelectorAll('main > section').forEach(el => el.classList.add('hidden'));
            // Show target
            document.getElementById('view-' + tabId).classList.remove('hidden');
            
            // Update Desktop Nav
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('bg-brand-500', 'text-white', 'shadow-lg', 'shadow-brand-500/25');
                btn.classList.add('text-slate-600', 'dark:text-slate-400', 'hover:bg-white/50', 'dark:hover:bg-white/5');
                if(btn.onclick.toString().includes(tabId)) {
                    btn.classList.remove('text-slate-600', 'dark:text-slate-400', 'hover:bg-white/50', 'dark:hover:bg-white/5');
                    btn.classList.add('bg-brand-500', 'text-white', 'shadow-lg', 'shadow-brand-500/25');
                }
            });

            // Update Mobile Nav
            document.querySelectorAll('.nav-icon').forEach(icon => {
                icon.classList.remove('text-brand-600', 'font-bold');
                icon.classList.add('text-slate-500');
                if(icon.dataset.target === tabId) {
                    icon.classList.remove('text-slate-500');
                    icon.classList.add('text-brand-600', 'font-bold');
                }
            });
            
            // Re-render charts if dashboard
            if(tabId === 'dashboard') {
                 // Trigger resize just in case
                 renderAll();
            }
        }

        // --- Modals ---
        function openModal(id) {
            document.getElementById(id).classList.remove('hidden');
        }
        function closeModal(id) {
            document.getElementById(id).classList.add('hidden');
        }

        // --- Settings / Utils ---
        function toggleTheme() {
            document.body.classList.toggle('dark');
            db.settings.theme = document.body.classList.contains('dark') ? 'dark' : 'light';
            saveDB();
            renderAll(); // Re-render charts for color update
        }

        function resetData() {
            if(confirm("Are you sure? This will delete ALL transactions and people permanently.")) {
                localStorage.removeItem(DB_KEY);
                location.reload();
            }
        }

        function exportData() {
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(db));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", "money_flow_backup_" + new Date().toISOString().slice(0,10) + ".json");
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
        }

        function importData(input) {
            const file = input.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const json = JSON.parse(e.target.result);
                    if(json.transactions && json.people) {
                        db = json;
                        saveDB();
                        alert('Data restored successfully!');
                        renderAll();
                    } else {
                        alert('Invalid backup file.');
                    }
                } catch(err) {
                    alert('Error reading file.');
                }
            };
            reader.readAsText(file);
        }

        // Start
        window.addEventListener('DOMContentLoaded', initApp);

    </script>
</body>
</html>
